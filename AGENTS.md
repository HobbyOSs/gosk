# AGENTS.md - GOSK Development Agent Guide

このドキュメントは、GOSKプロジェクトの開発を支援するコーディングエージェント向けのガイドです。プロジェクトの目的、技術スタック、アーキテクチャ、開発ルールについて説明します。

## 1. プロジェクト概要

### 目的
GOSKは、Go言語で書かれたx86アセンブラであり、NASKに似たアセンブリ言語を解析し、COFF形式のオブジェクトファイルなどの機械語を生成することを目的としています。

### 主要機能
-   NASK風アセンブリコードのパース
-   PEG (Parsing Expression Grammar) を用いた構文解析
-   抽象構文木 (AST) の生成と評価
-   COFFオブジェクトファイルの生成
-   命令セット情報の管理 (json-x86-64-go-mod)

## 2. 技術スタックと開発環境

-   **言語:** Go (1.24.4)
-   **ビルド:** `Makefile` を使用 (`make build`)
-   **構文解析:**
    -   `pigeon` を用いたPEGパーサ (`internal/gen`)
    -   オペランド解析にも`pigeon`を使用 (`pkg/ng_operand`)
-   **テスト:** Go標準のテストフレームワークおよび`testify/suite`
-   **依存関係:**
    -   `github.com/HobbyOSs/json-x86-64-go-mod`: x86命令セットデータを提供します。
    -   その他、`go.mod`を参照してください。

## 3. アーキテクチャ

GOSKは、2パス構成のアセンブラです。

1.  **Pass1 (`internal/pass1`):**
    * AST (抽象構文木) を走査し、マクロ(`EQU`)の展開、定数畳み込み、ラベルアドレスの決定、および各命令の機械語サイズ計算を行います。
    * この段階で、中間表現である **Ocode** を生成します。

2.  **Pass2 (`internal/pass2`):**
    * Pass1で生成されたOcodeとシンボルテーブルを元に、最終的なアドレス解決（特に前方参照ラベル）を行います。
    * この処理を経て、最終的な機械語を生成するために`codegen`を呼び出します。

3.  **AST中心の評価:**
    * かつてのトークンベースの評価から、ASTの各ノードが`Eval()`メソッドを持つ設計に変更されました。
    * これにより、`[LABEL + 30]`のような複雑なオペランド表現の評価が、構造を保ったまま柔軟に行えるようになっています。

4.  **Codegen (`internal/codegen`):**
    * Pass2から渡されたOcodeに基づき、最終的なx86機械語のバイトシーケンスを生成します。

5.  **ファイルフォーマット (`internal/filefmt`):**
    * `codegen`で生成された機械語とシンボルテーブル情報を元に、指定されたファイル形式（現在はCOFF）のバイナリを構築します。

## 4. 開発ルールとパターン

### テスト実行
-   テストは最小単位で実行し、変更が完了した後に全体テストを行います。
-   テストスイート内の特定メソッドを実行する場合: `go test ./test/ -run <TestSuiteName>/<TestMethodName>`
    * 例: `go test ./test/ -run Day03Suite/TestHarib00g`
-   E2Eテストの期待値バイナリは、基準となるアセンブラ(NASK)の出力を元に、提供されたGoプログラムを使って生成します。手動での転記は避けてください。

### ソースコード修正
-   変更は最小限に留め、既存のコードパターンを踏襲してください。
-   関数名は`processINST` (pass1)、`handleINST` (codegen) のように、役割がわかるように命名します。
-   エラーメッセージは具体的に記述し、エラーは適切な層で処理してください。

### JSON DB (x86命令定義)
-   命令のエンコーディング情報を調査する際は、`jq`コマンドを活用してください。具体的なコマンド例は`memory-bank/core/rules_extras.md`にあります。
-   命令がJSON DBに存在しない場合は、`pkg/asmdb/instruction_table_fallback.go`にフォールバックを実装します。