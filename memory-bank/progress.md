# Progress

## 実装済みの機能
- アセンブラ命令実装のルーチンの定義
  - Pass1での命令実装手順
  - Ocodeの実装手順
  - 機械語生成の実装手順
  - 実装時の注意点の整理
- テストスイートの構造化
  - day01からday20までのテストケース構造の確立
  - 各dayでの新しい命令の追加パターンの明確化
  - テストケースの内容と検証方法の整理
- x86アセンブラの解析
- ASTの生成
- 基本的なコード生成
- `GetOutputSize` 関数の引数に `OutputSizeOptions` 構造体を追加
- PEGを用いた構文解析の最適化
- Pass1の基本的な評価処理
- トークン解析の基本実装
- オペランドの基本実装
- x86のprefix bytes判定機能の実装
  - オペランドサイズプレフィックス(66h)の判定
  - アドレスサイズプレフィックス(67h)の判定
- 機械語サイズ計算機能の完成
  - プレフィックスバイトのサイズ計算を実装
  - オフセットとプレフィックスを含めた正確なサイズ計算
  - 複数の機械語パターンがある場合の最適な選択機能を実装
    - FindFormをFindEncodingに変更し、最小サイズのエンコーディングを直接選択
    - 複数の機械語パターンから最適なエンコーディングを一意に選択（例：MOV r16, imm16）
- 算術命令の基本構造の実装開始
  - 共通処理を行うヘルパー関数の実装
  - 各命令の基本的なハンドラー関数の定義
  - ADD命令の機械語生成を実装
    - プレフィックスバイト(66h)の処理
    - オペコードの生成
    - ModR/Mバイトの生成
    - 即値の処理
- システム命令の実装完了
  - INT命令（BIOS呼び出し）の実装
    - 2バイト命令（0xCD + 割り込み番号）
    - Ocodeの定義と機械語生成
  - HLT命令（CPU停止）の実装
    - 1バイト命令（0xF4）
    - パラメータなし命令としての処理
- Ocodeの使い方のドキュメント化
  - パラメータなし命令の実装パターン
  - パラメータあり命令の実装パターン
  - Emit関数の使用方法
  - 機械語サイズの計算方法
- 制御フロー命令の実装
  - JMP命令 (JMP rel8)
    - Pass1: processJMP 関数実装 (internal/pass1/pass1_inst_jmp.go)
    - Ocode: OpJMP 定義 (pkg/ocode/ocode.go)
    - 機械語生成: handleJMP 関数実装 (internal/codegen/x86gen_jmp.go)

## まだ構築が必要な部分
- Day02の実装
  - 基本命令
    - [ ] MOV命令（レジスタ間、即値、セグメントレジスタ）
    - [ ] ADD命令（フラグ更新）
    - [ ] CMP命令（比較演算、フラグ設定）
  - メモリ操作
    - [ ] メモリアドレッシング
    - [ ] レジスタ-メモリ間転送
    - [ ] ModR/M生成
  - 制御フロー
    - [ ] JE命令（条件分岐）
    - [ ] JMP命令
      - [ ] 相対アドレス計算
      - [ ] ジャンプ先ラベル解決
  - システム命令

- day03からday20までの命令実装
  - 各dayで追加される新しい命令の実装
  - テストケースの有効化と検証
- 算術命令の完全な実装
  - Ocodeの定義
  - 機械語生成の実装
  - ModR/Mの生成
  - テストケースの修正と有効化
- 高度なコード生成機能
- ユーザーインターフェースの改善
- `asmdb`と`operand`の依存関係の整理と設計修正
- Pass1の評価処理の完全なテストカバレッジ
- トークン解析の最適化と完全性の確保
- オペランド実装の完成度向上
- スタックマシンベースの設計の最適化

## 現在の進捗状況
- テストスイートの構造を明確化
  - day01からday20までの段階的実装計画を確立
  - 各dayのテストケースの分析を開始
- 算術命令の実装を開始
  - 基本構造の実装
  - テストの一時的なスキップ
- Pass1の評価処理のテスト強化中
- トークン解析の改善作業進行中
- オペランド実装の改善中
- テストスイートの継続的な拡充
- 機械語サイズ計算機能の実装完了
- 制御フロー命令 JMP (rel8) の実装完了

## 既知の問題
- x86_64.jsonの制限
  - セグメントレジスタ関連の命令定義が不足
  - 影響を受ける命令：
    - MOV SS,AX
    - MOV DS,AX
    - MOV ES,AX
  - 対応方針：
    1. 基本的な命令を優先実装
    2. json-x86-64の拡張を検討

- day02以降のテストケースが未実装
  - 必要な命令の実装が必要
  - テストケースの有効化が必要
- 算術命令の実装が進行中
  - ADD命令の機械語生成が完了
  - 他の算術命令の実装が必要
  - フラグ更新の処理が必要
  - テストケースの修正が必要
- トークン解析の一部ケースで最適化の余地あり
- オペランドの種別判定の精度向上が必要
- スタックマシン関連の構造に改善の余地あり
