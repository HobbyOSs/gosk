# 現在の状況 (Active Context) - 2025/03/30

# 現在の状況 (Active Context) - 2025/03/30 (更新)

## 現在の焦点
- **`TestDay03Suite/TestHarib00i` のテスト失敗調査 (継続):**
    - 問題: バイナリ差分と長さの不一致 (expected 304, actual 300)。
    - **原因再考:**
        - `66h` プレフィックス欠落問題 (`MOV EAX, CR0` 等) は `pkg/ng_operand/requires.go` 修正で解消されたように見えたが、根本原因ではなかった可能性。
        - **`IMUL`/`SUB` のエンコーディング選択:** 即値が `imm8` 範囲外でも `imm8` 形式 (Opcode `6B`/`83`) が選択されている。`asmdb.FindEncoding` のエンコーディング選択ロジック (`lo.MinBy`) に問題がある可能性が高い。
        - **`JMP DWORD ptr` のエンコーディング:** 未実装または不正確な実装の可能性。
        - **ラベル/定数/データ定義:** アドレス解決やアラインメント処理の問題の可能性。
- **エンコーディング検索アーキテクチャの見直し検討:**
    - ユーザー提案: `imm*` を区別せず広く候補を集め、後段で絞り込む方式 (`relaxImmSearch` フラグ等)。符号拡張の扱いを改善する可能性。
    - 関連: `forceImm8` フラグの廃止検討。
    - (詳細: [エンコーディング検索アーキテクチャの見直し案](../details/technical_notes.md#エンコーディング検索アーキテクチャの見直し案-20250330))

## 次のステップ
1. **`asmdb.FindEncoding` の修正:** `lo.MinBy` の比較ロジックを再修正し、`IMUL`/`SUB` で即値サイズに基づき正しいエンコーディング (`69`/`81` vs `6B`/`83`) が選択されるようにする。(保留 - 次セッションでアーキテクチャ見直しから着手)
2. **`JMP DWORD ptr` の実装確認・修正:** `pass1` (LOC計算) と `codegen` (エンコーディング) を確認・修正する。
3. **ラベル/定数/データ定義の問題調査・修正:** アドレス解決、定数計算、アラインメント処理を確認・修正する。
4. **(並行/上記の後) エンコーディング検索アーキテクチャの見直し:** ユーザー提案の `relaxImmSearch` アプローチを検討・実装する。
5. `pkg/ng_operand` への置換作業を進める。

(過去の完了作業: [activeContext_archive_202503.md](../archives/activeContext_archive_202503.md))
